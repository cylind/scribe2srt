# Scribe to SRT (Powered by ElevenLabs)

[![Latest Release](https://img.shields.io/github/v/release/cylind/scribe2srt?style=for-the-badge&logo=github)](https://github.com/cylind/scribe2srt/releases/latest)

这是一个使用 Python 和 PySide6 构建的桌面应用程序，它可以将**音频/视频文件**或 **ElevenLabs Scribe 的 JSON 转录文本**通过 [ElevenLabs Speech-to-Text API](https://elevenlabs.io/speech-to-text) 转换为**专业级** `.srt` 字幕文件。

本工具基于**字幕制作的通用原则**，遵循Netflix、TED等专业机构的字幕标准，特别针对**中文、日文、韩语和英文**内容进行了深度优化，提供智能的字幕切分和格式化规则，确保生成的字幕具有**专业级的可读性和观影体验**。

## ✨ 功能特性

### 🎬 专业级字幕引擎
基于**字幕制作的通用原则**，遵循Netflix、TED、BBC等专业机构标准：

- **🧠 智能语义分组**: 通过分析语音中的**停顿**和**标点符号**，将语音智能地组合成符合语义和说话节奏的字幕块
- **⚡ 动态CPS控制**:
  - 根据文本长度动态调整每秒字符数（CPS）限制
  - 中文/日文/韩文：11字符/秒，英文：15字符/秒
  - 短文本允许更高CPS，确保极短字幕的可读性
- **📏 智能行长控制**:
  - 中文/日文/韩文：每行最多25字符
  - 英文等拉丁语言：每行最多42字符
  - 遵循语义完整性优先的断行原则
- **⏱️ 专业时间控制**:
  - 最短显示时间：0.83秒（Netflix标准）
  - 最长显示时间：7秒
  - 字幕间最小间隔：0.083秒（约2帧@24fps）
- **🔧 Spacing字符修复**: 自动过滤转录中的spacing字符，避免时间计算错误

### 🚀 高效媒体处理
- **⚡ 异步音频片段处理 (v0.3.0新增)**:
  - **3-5倍速度提升**: 长音频文件切分后的片段支持并发上传和转录，显著提升处理效率
  - **智能并发控制**: 可配置并发片段数量（1-10个，默认3个），根据网络状况和API限制灵活调整
  - **分段式进度条**: 按音频片段大小比例显示进度，不同颜色区分各片段，实时显示总体进度和完成状态
  - **智能降级机制**: 异步处理失败时自动切换到顺序处理模式，确保任务完成
- **📂 长音频/视频自动分片**: 针对长时间的媒体文件，程序会自动调用 FFmpeg 将其切分成小片段进行上传，显著提高了大文件的转录成功率和处理效率
- **🎵 无损音频提取**: 在处理视频文件时，程序会使用 `ffprobe` 智能检测音频编码，然后通过 **无损流复制 (Stream Copy)** 的方式提取原始音频，既保证了速度，又避免了质量损失
- **📄 多格式输入**: 不仅支持各类音视频文件，还支持直接处理 ElevenLabs Scribe 生成的 `.json` 文件，跳过上传和转录步骤，直接生成SRT字幕

### 💪 健壮的任务处理
- **🔄 任务取消与重试**: 用户可以随时取消正在进行的任务。如果任务因网络等原因失败，程序会提供重试选项
- **📍 断点续传**: 对于分片处理的任务，重试时可以从上一个失败的片段处恢复，无需从头开始

### 🎨 简洁易用的界面
- **🖱️ 拖拽操作**: 支持将文件直接拖拽到应用窗口
- **📊 智能进度显示 (v0.3.0增强)**:
  - **分段式进度条**: 按音频片段大小比例分配进度条空间，不同颜色区分各片段
  - **详细进度信息**: 显示总体进度、已完成片段数、总文件大小等详细信息
  - **实时状态反馈**: 通过详细的日志区域，实时展示任务处理状态
- **⚙️ 双重设置系统 (v0.3.0新增)**:
  - **并发处理设置**: 配置异步处理参数（并发数、重试次数、API速率限制、切分阈值）
  - **字幕设置**: 调整所有字幕参数，包括CPS、CPL、时长等专业设置
- **🔊 声音事件识别**: 可选择识别并标记非语音的声音事件（如 `[音乐]`、`[笑声]`）
- **🌐 跨平台**: 基于 PySide6 构建，支持 Windows, macOS, 和 Linux

## 🎯 专业字幕标准

本工具基于**字幕制作的通用原则**，整合了Netflix、TED、BBC等专业机构的字幕标准，确保生成的字幕具有专业级质量：

### 📐 时间轴与切分标准
- **最小显示时长**: 0.83秒（Netflix标准，相当于24fps下的20帧）
- **最大显示时长**: 7秒（避免阅读疲劳和跨镜头问题）
- **字幕间隔**: 最小0.083秒（约2帧），为大脑提供信息分割信号

### 🔤 可读性与格式化
- **动态CPS控制**: 根据文本长度智能调整每秒字符数限制
  - 极短文本（≤3字符）：允许3倍基础CPS
  - 短文本（≤5字符）：允许2倍基础CPS
  - 中短文本（≤10字符）：允许1.5倍基础CPS
- **语义完整性断行**: 遵循Netflix规则，在逻辑停顿处断行，保持语义单元完整
- **语言特化优化**: 针对中日韩高信息密度语言和拉丁语言分别优化

### 🔧 技术创新
- **Spacing字符修复**: 自动识别并过滤转录中的spacing字符，避免时间计算错误
- **智能语义分组**: 基于停顿和标点符号的双重分析
- **专业时间同步**: 确保字幕与音频的精准对应

> 📚 **详细标准**: 完整的字幕制作原则请参考 [doc/字幕制作的通用原则.txt](doc/字幕制作的通用原则.txt)

## 🖼️ 应用截图

![App Screenshot Placeholder](./Scribe2SRT-Screenshot.png)

## 🚀 安装与运行

### 快速开始 (推荐)

对于大多数用户，最简单的方式是直接从我们的 **Releases** 页面下载最新的预编译可执行文件。

1.  **[➡️ 前往最新的 Release 页面](https://github.com/cylind/scribe2srt/releases/latest)**
2.  根据您的操作系统，下载对应的文件（例如 `Scribe2SRT-v1.0.0-windows-x86_64.zip`）。
3.  解压文件，直接运行其中的可执行程序即可。

> **提示 (可选):**
> 为了获得处理视频文件的最佳体验（速度更快，消耗流量更少），建议您在电脑上安装 **FFmpeg**。程序会自动检测并使用它。如果不安装，程序会尝试直接上传整个视频文件，这可能耗时更长。

---

<details>
<summary><b>👨‍💻 开发者：从源码运行</b></summary>

如果您是开发者或希望从源码运行，请按照以下步骤操作。

**1. 克隆仓库**

```bash
git clone https://github.com/cylind/scribe2srt.git
cd scribe2srt
```

**2. (可选, 但强烈推荐) 安装 FFmpeg**

为了最高效地处理视频文件（如 `.mp4`, `.mkv`），强烈推荐您安装 FFmpeg，并将其添加到系统的 `PATH` 环境变量中。

- **Windows**:
  - 从 [FFmpeg 官网](https://ffmpeg.org/download.html) 下载。
  - 解压后，将 `bin` 目录的路径添加到系统的环境变量 `Path` 中。
- **macOS** (使用 [Homebrew](https://brew.sh/)):
  ```bash
  brew install ffmpeg
  ```
- **Linux** (使用 apt,适用于 Debian/Ubuntu):
  ```bash
  sudo apt update && sudo apt install ffmpeg
  ```

您可以在终端或命令提示符中运行 `ffmpeg -version` 来验证是否安装成功。

**3. 创建并激活虚拟环境**

- **Windows**:
  ```bash
  python -m venv venv
  .\venv\Scripts\activate
  ```
- **macOS / Linux**:
  ```bash
  python3 -m venv venv
  source venv/bin/activate
  ```

**4. 安装依赖**

```bash
pip install -r requirements.txt
```

**5. 运行应用**

```bash
python app.py
```

</details>

## 📖 使用说明

### 基础使用
1.  **选择文件**:
    - 点击 **"点击选择文件"** 按钮或直接拖拽文件到窗口
    - 支持的格式包括：
        - **音视频文件**: `.mp3`, `.mp4`, `.wav`, `.mkv` 等
        - **Scribe转录文件**: `.json`
2.  **配置选项**:
    - **源语言**: 选择音频的主要语言。如果选择 "自动检测"，ElevenLabs API 会尝试自动识别
    - **识别声音事件**: 勾选此项后，API会尝试识别并输出 `[音乐]`、`[掌声]` 等非语音事件
3.  **开始生成**:
    - 点击 **"生成字幕"** 按钮
    - 应用将开始处理任务，你可以在进度条和日志区域看到当前状态
4.  **完成**:
    - 任务成功后，会弹出成功的提示框
    - 生成的 `.srt` 文件（以及可能的 `.json` 文件）会自动保存在与源文件相同的目录下

### 高级设置

#### 🚀 并发处理设置 (v0.3.0新增)
点击 **"并发处理设置"** 按钮可以配置异步处理参数：

##### ⚡ 异步处理控制
- **启用异步并发处理**: 开启后可显著提升长音频文件的处理速度（3-5倍提升）
- **最大并发片段数**: 1-10个（推荐3个）
  - 数值越高处理越快，但会增加API请求压力
  - 建议根据网络状况和API稳定性调整
- **失败重试次数**: 1-10次（推荐3次）
  - 片段处理失败时的自动重试次数
  - 使用指数退避策略，避免频繁重试

##### 🌐 API速率控制
- **API速率限制**: 10-100请求/分钟（推荐30）
  - 控制向ElevenLabs API发送请求的频率
  - 避免触发API速率限制，确保处理稳定性

##### ✂️ 音频切分设置
- **长文件自动切分阈值**: 10-240分钟（推荐90分钟）
  - 超过此时长的音频文件将自动切分为小片段
  - 切分后的片段支持异步并发处理

> **💡 性能提示**:
> - 对于长音频文件（>90分钟），建议启用异步处理以获得最佳性能
> - 网络不稳定时可降低并发数或关闭异步处理
> - 如遇到问题，系统会自动降级到顺序处理模式

#### 📝 字幕设置
点击 **"字幕设置"** 按钮可以调整专业字幕参数：

#### 📊 阅读速度控制 (CPS - 每秒字符数)
- **中文/日文/韩文**: 8-20字符/秒（推荐11）
- **英文等拉丁语言**: 10-25字符/秒（推荐15）

#### 📏 每行字符数限制 (CPL)
- **中文/日文/韩文**: 12-30字符（推荐25）
- **英文等拉丁语言**: 30-60字符（推荐42）

#### ⏱️ 时间控制
- **最短显示时间**: 0.5-2.0秒（推荐0.83秒）
- **最长显示时间**: 5.0-10.0秒（推荐7.0秒）
- **字幕间最小间隔**: 0.04-0.2秒（推荐0.083秒）
- **停顿阈值**: 0.3-1.5秒（推荐0.7秒）

> **💡 提示**: 默认设置已经基于专业标准进行了优化，大多数情况下无需调整。如需自定义，建议参考[字幕制作的通用原则](doc/字幕制作的通用原则.txt)。

## 🛠️ 关于 ElevenLabs API

本工具使用 ElevenLabs 的语音转文本 API。当前版本的代码使用了允许**未经身份验证**的 API 端点，因此**不需要**手动配置 API 密钥。

## 📋 版本更新日志

### v0.3.0 (2024-06-18) - 异步处理重大更新 🚀

#### 🆕 新功能
- **⚡ 异步音频片段处理**: 长音频文件切分后支持并发上传和转录，处理速度提升3-5倍
- **🎛️ 并发处理设置界面**: 新增专门的设置对话框，可配置并发数量、重试次数、API速率限制等
- **📊 分段式进度条**: 按音频片段大小比例显示进度，不同颜色区分各片段，提供详细的处理状态信息
- **🔧 智能降级机制**: 异步处理失败时自动切换到顺序处理模式，确保任务完成

#### 🔧 技术改进
- **Qt线程池集成**: 使用Qt的QThreadPool和QRunnable，确保与Qt事件循环完美兼容
- **增强错误处理**: 完善的重试机制、错误恢复和状态管理
- **完整资源清理**: 改进临时文件清理，包括提取的音频文件和JSON文件
- **线程安全保证**: 使用QMutex和QSemaphore确保并发处理的线程安全

#### 🎨 界面优化
- **设置重组**: 将切分时长阈值从字幕设置移动到并发处理设置
- **进度可视化**: 分段进度条提供更直观的处理状态反馈
- **配置持久化**: 所有异步处理设置可保存和恢复

#### 🐛 问题修复
- 修复异步处理完成后卡住不动的问题
- 修复取消任务时临时文件清理不完整的问题
- 改进断点续传在异步模式下的兼容性

> **升级建议**: v0.3.0完全向后兼容，现有用户可直接升级。建议长音频文件用户启用异步处理以获得最佳性能。
